name: CML CD for Iris API

on:
  push:
    branches: ["master", "main"]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write   # Needed for CML to post comments

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    # ✅ Authenticate to Google Cloud using service account key
    - name: Authenticate to GCP
      uses: google-github-actions/auth@v1
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    # ✅ Automatically fetch GKE credentials using service account
    - name: Get GKE credentials
      uses: google-github-actions/get-gke-credentials@v1
      with:
        cluster_name: autopilot-fastapi-cluster-1
        location: us-central1
        project_id: sunlit-vortex-459609-m8

    # ✅ Docker build
    - name: Set up Docker
      uses: docker/setup-buildx-action@v2

    - name: Build Docker image
      run: docker build -t iris-api:latest .

    - name: Save Docker image
      run: docker save iris-api:latest -o iris-api.tar

    - name: Load image into local cluster (kind) [Optional]
      run: kind load image-archive iris-api.tar || echo "Skipping kind load"

    # ✅ Deploy to Kubernetes
    - name: Deploy to Kubernetes
      run: |
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml

    # ✅ Install CML
    - name: Install CML
      run: npm install -g @dvcorg/cml

    # ✅ CML Report
    - name: Generate and post CML report
      env:
        REPO_TOKEN: ${{ secrets.GH_PAT }}   # Use a Personal Access Token with repo access
      run: |
        echo "## 🚀 Deployment Report" > report.md
        echo "\n### ✅ Deployed FastAPI Iris App" >> report.md
        echo "\n#### 🐳 Docker Image: iris-api:latest" >> report.md
        echo "\n#### 📦 Kubernetes Pods:" >> report.md
        kubectl get pods >> report.md
        npx cml comment create report.md

